<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="${title}">Member Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .form-label { font-weight: 500; }
        #passwordSection { display: none; }
    </style>
</head>
<body class="bg-light">
<div class="d-flex min-vh-100">
    <div th:replace="~{fragments/sidebaradmin :: sidebaradmin}"></div>
    <main class="flex-grow-1 overflow-auto">
        <div class="container py-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 th:text="${title}">Add/Edit Member</h4>
            </div>
            <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                <span th:text="${success}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <span th:text="${error}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <div class="card shadow-sm">
                <div class="card-body">
                    <form th:action="@{/admin/users/save}" th:object="${user}" method="post" class="row g-4">

                        <!-- Hidden ID for edit mode -->
                        <input type="hidden" th:field="*{id}"/>
                        <div class="col-md-6">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-control" th:field="*{fullName}" required/>
                            <div class="text-danger mt-1" th:if="${#fields.hasErrors('fullName')}" th:errors="*{fullName}"></div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Username *</label>
                            <input type="text" class="form-control" th:field="*{username}" required/>
                            <div class="text-danger mt-1" th:if="${#fields.hasErrors('username')}" th:errors="*{username}"></div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" th:field="*{email}"/>
                            <div class="text-danger mt-1" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Roles *</label>
                            <select class="form-select" th:field="*{roles}" multiple="multiple" size="5" required>
                                <option th:each="role : ${allRoles}"
                                        th:value="${role.id}"
                                        th:text="${role.name}">
                                </option>
                            </select>
                            <div class="text-danger mt-1" th:if="${#fields.hasErrors('roles')}" th:errors="*{roles}"></div>
                        </div>
                        
                        <!-- Password fields for NEW users only -->
                        <div th:if="${user.id == null}" class="col-md-6">
                            <label class="form-label">Password *</label>
                            <input type="password" 
                                   class="form-control" 
                                   th:field="*{password}" 
                                   required />
                            <div class="text-danger mt-1" 
                                 th:if="${#fields.hasErrors('password')}" 
                                 th:errors="*{password}">Password error</div>
                        </div>

                        <div th:if="${user.id == null}" class="col-md-6">
                            <label class="form-label">Confirm Password *</label>
                            <input type="password" 
                                   class="form-control" 
                                   name="confirmPassword" 
                                   required />
                            
                            <!-- Show error only if passwords don't match (set from controller) -->
                            <div class="text-danger mt-1" th:if="${passwordMismatch}" th:text="${passwordMismatch}">
                                Passwords do not match
                            </div>
                        </div>

                        <!-- Change Password button for EXISTING users -->
                        <div th:if="${user.id != null}" class="col-12">
                            <div class="alert alert-info d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-info-circle me-2"></i>To change this user's password, click the button below.</span>
                                <button type="button" class="btn btn-primary btn-sm" id="togglePasswordBtn">
                                    <i class="fas fa-key me-1"></i> Change Password
                                </button>
                            </div>
                        </div>

                        <!-- Password fields for EXISTING users (hidden by default) -->
                        <div th:if="${user.id != null}" id="passwordSection" class="col-12">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">New Password *</label>
                                    <input type="password" 
                                           class="form-control" 
                                           th:field="*{password}" 
                                           id="newPassword" />
                                    <div class="text-danger mt-1" 
                                         th:if="${#fields.hasErrors('password')}" 
                                         th:errors="*{password}">Password error</div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Confirm New Password *</label>
                                    <input type="password" 
                                           class="form-control" 
                                           name="confirmPassword" 
                                           id="confirmPassword" />
                                    
                                    <div class="text-danger mt-1" th:if="${passwordMismatch}" th:text="${passwordMismatch}">
                                        Passwords do not match
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="col-12 mt-5">
                            <button type="submit" class="btn btn-success px-5">Save Member</button>
                            <a th:href="@{/admin/users}" class="btn btn-secondary ms-3 px-5">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Toggle password fields for existing users
    const toggleBtn = document.getElementById('togglePasswordBtn');
    const passwordSection = document.getElementById('passwordSection');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    
    if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
            if (passwordSection.style.display === 'none' || passwordSection.style.display === '') {
                // Show password fields
                passwordSection.style.display = 'block';
                newPasswordInput.setAttribute('required', 'required');
                confirmPasswordInput.setAttribute('required', 'required');
                toggleBtn.innerHTML = '<i class="fas fa-times me-1"></i> Cancel Password Change';
                toggleBtn.classList.remove('btn-primary');
                toggleBtn.classList.add('btn-secondary');
            } else {
                // Hide password fields
                passwordSection.style.display = 'none';
                newPasswordInput.removeAttribute('required');
                confirmPasswordInput.removeAttribute('required');
                newPasswordInput.value = '';
                confirmPasswordInput.value = '';
                toggleBtn.innerHTML = '<i class="fas fa-key me-1"></i> Change Password';
                toggleBtn.classList.remove('btn-secondary');
                toggleBtn.classList.add('btn-primary');
            }
        });
    }
</script>
</body>
</html>